---
title: Analysis of parasitoid performance vs transfected lineages of hamiltonella-protected
  aphids
date: ""
editor_options:
  chunk_output_type: inline
output:
  pdf_document:
    toc: yes
  html_document:
    theme: yeti
    toc: yes
    toc_float: yes
authors: Maxime & Youn
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
```


# Packages

```{r packages-loading}
#[R v4.0.5]

if(require("pacman")==T){
  library("pacman")
}else{
  install.packages("pacman")
}

if(require("cmdstanr")==T){
  library("cmdstanr")
}else{
  install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
}


pacman::p_load(rstan, brms, Rmisc, tidyverse, patchwork, ggplot2, ggtext, bayesplot, tidybayes, kableExtra)

#library(rstan)
## Stan backend

#library(cmdstanr)  # [github::stan-dev/cmdstanr] v0.3.0 
## Stan backend (another)

#library(brms)      # CRAN v2.15.0        
## the interface we are using

#library(tidyverse) # CRAN v1.3.0   

#plotting
#library(patchwork) # CRAN v1.1.1   
#library(ggtext)    # CRAN v0.1.1      

#library(bayesplot) # CRAN v1.8.0   
#library(tidybayes) # CRAN v2.3.1   

library(here)      # CRAN v1.0.1
## tool for workspace location management
## automatically detects the workspace after loading the package if Rstudio was opened using the script file (or with new R project)
## load last to avoid conflicts

## some useful default settings
# rstan_options(auto_write = TRUE) #for rstan
options(mc.cores = 2) ## reduce/increase depending on cores available
```

# Overview

Loading the data

```{r data-load}

raw_data=read.table(here("data","data_parasitism_R.txt"),h=T, dec=".")
```

Take a look at the dataset

```{r overlook}
## tinkering better order of wasps for plotting
order.wasps=c("Yp20-027",	"Yp20-038", "Yp20-081", "Yp20-004", "Yp20-006",	"Yp20-009", "Yp20-013", "Yp20-035", "Yp20-037", "Yp20-050", "Yp20-058", "Yp20-060", "Yp20-068", "Yp20-075",	"Yp20-079",	 "Yp20-084", "F316", "G339", "G363", "G392", "S251", "S350", "Yp20-003", "Yp20-032",	"Yp20-002", "Yp20-021", "Yp20-033", "Yp20-044", "Yp20-048", "Yp20-055", "Yp20-063", "Yp20-070", "Yp20-071", "Yp20-072", "Yp20-080")
order.aphids=c("NTR-407","TR-0016","TR-0103","TR-0131","TR-0191","TR-0619","TR-0042","TR-0076","TR-0214","TR-0244")
order.origin=c("Aphis_urticata","Aphis_ruborum","Aphis_fabae_fabae","Aphis_hederae")

data<-na.omit(raw_data) %>% 
  mutate(Parasitoid_line=factor(Parasitoid_line),
         Aphid_line=factor(Aphid_line),
         Hamiltonella_host_species=factor(Hamiltonella_host_species),
         Wasp_host_species=factor(Wasp_host_species)) %>% 
  mutate(replicate_fullID=paste(Aphid_line,Replicate),
         observation=1:length(Aphid_line))

data=data %>%
  mutate(Parasitoid_line = factor(Parasitoid_line, levels = order.wasps)) %>%
  arrange(Parasitoid_line)    
data=data %>%
  mutate(Aphid_line = factor(Aphid_line, levels = order.aphids)) %>%
  arrange(Aphid_line) 

success=as.numeric(data$Mummies_amount)/as.numeric(data$Nymphs_corrected)
data$Parasitism_success=success
mean_data=group.CI(Parasitism_success ~ Parasitoid_line*Aphid_line, data=data, ci = 0.95)
mean_data$Wasp_host_species=rep(c(
  "Aphis_urticata","Aphis_urticata","Aphis_urticata","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_ruborum","Aphis_fabae_fabae","Aphis_fabae_fabae","Aphis_fabae_fabae","Aphis_fabae_fabae","Aphis_fabae_fabae","Aphis_fabae_fabae","Aphis_fabae_fabae","Aphis_fabae_fabae","Aphis_hederae","Aphis_hederae","Aphis_hederae","Aphis_hederae","Aphis_hederae","Aphis_hederae","Aphis_hederae","Aphis_hederae","Aphis_hederae","Aphis_hederae","Aphis_hederae"
),10)

## bubble plot
colors=c("#66ccff", "#aa80ff", "#88ff4d", "#ff9900")
ggSize=0.25
bubbles<-ggplot(data=NULL, aes(Parasitoid_line, Aphid_line))+
  geom_point(data=mean_data, aes(size=Parasitism_success.mean*25, color=Wasp_host_species, shape=16))+ ##adjust size to frequency
  scale_shape_identity()+
  scale_colour_manual(values=colors)+ ##define custom colors for protected and unprotected
  geom_text (data=mean_data[mean_data$Parasitism_success.mean>=0.01,], aes(label=round(Parasitism_success.mean*100,0)), size=3.5)+ 
  scale_size_identity()+ ##do not plot zero frequency
  scale_x_discrete(limits= levels(mean_data$Parasitoid_line))+ ##reorder axes according to levels of factor
  scale_y_discrete(labels=levels(mean_data$Aphid_line))+
  labs(title=NULL, x="Parasitoid line", y="Aphid line")+ theme(legend.position="none")+
  ##geom_hline(yintercept=1.5,lwd=ggSize)+
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position="none",
        axis.title.y=element_text(size=10),
        axis.title.x=element_text(size=10, vjust=-1),
        axis.text.x=element_text(angle=90,size=10,colour='black'),
        axis.text.y=element_text(size=10,colour='black'),
        axis.ticks=element_line(size=ggSize), 
        axis.line = element_line(size =ggSize, colour='black'))
bubbles

if(file.exists(here("Plot_bubbles.pdf"))){
  
  }else
    {
pdf(height=4, width=10, file="Plot_bubbles.pdf")
bubbles
dev.off()}
```

# Data preparation

```{r data-preparation}
data<-na.omit(raw_data) %>% 
  mutate(Parasitoid_line=factor(Parasitoid_line),
         Aphid_line=factor(Aphid_line),
         Hamiltonella_host_species=factor(Hamiltonella_host_species),
         Wasp_host_species=factor(Wasp_host_species)) %>% 
  mutate(replicate_fullID=paste(Aphid_line,Replicate),
         observation=1:length(Aphid_line))

data<-data %>% 
  ## create origin columns with no underscore for goood looking plots
  ## and species names we will be able to display 
  ## in italic using the markdown facilities in ggtext
  mutate(
    Origin_para=str_replace_all(Wasp_host_species,"_"," "),
    Origin_ham=str_replace_all(Hamiltonella_host_species,"_"," ")
  ) %>% 
  mutate(
    Origin_para=str_replace_all(Origin_para,"Aphis","A."),
    Origin_ham=str_replace_all(Origin_ham,"Aphis","A.")
  ) %>% 
  mutate(Origin_para=factor(paste("Parasitoid source host: *",Origin_para,"*",sep="")),
         Origin_ham=paste("*",Origin_ham,"*",sep="")) %>%
  mutate(Origin_ham=fct_recode(Origin_ham,none="*none*")) %>% 
  ## we finish by ensuring the no-Ham control is the first level for both 
  ## Aphid_line and host_origin variables, for the model
  mutate(Aphid_line = fct_relevel(Aphid_line, 
                             "NTR-407", after=0),  
         Hamiltonella_host_species=fct_relevel(factor(Hamiltonella_host_species),
                                               "none",after=0),
         Origin_ham=fct_relevel(factor(Origin_ham),
                                 "none",after=0)
         )


```


# Models with bayesian approach

## Priors

Weakely informative priors from McElreath (2020)
```{r prior}
prior=c(
  set_prior("normal(0,1.5)", class="b"), # can be improved
  set_prior("normal(0,1)", class="sd"), # can be replaced by exponential(1) (larger)
  set_prior("lkj(2)",class="cor") ##correlations between random effects
  # can loose that with lkj(1)
)

prior_nocors=c(
  set_prior("normal(0,1.5)", class="b"),
  set_prior("normal(0,1)", class="sd")
)
```

## Model 1

Let's start with a simple binomial model:

```{r mod_noOLRE}
if(file.exists(here("R_output","mod_noOLRE.Rdata"))){
  # this if-else statement is avoid re-fitting a model if there is already one existing in R_output
  # to override, re-run the model and re-save manually by selecting only the relevant code lines (or delete the Rdata object before relaunching this code chunk)
  load(here("R_output","mod_noOLRE.Rdata"))
  }else
    {

mod <- brm(
  bf(Mummies_amount|trials(Nymphs_corrected)~
       0+Wasp_host_species+Wasp_host_species:Hamiltonella_host_species+ ## origin in the wild are fixed effects
       (Hamiltonella_host_species|Parasitoid_line)+ ## parasitoid lines have a random effect nested by hamiltonella origin
       (0+Aphid_line|Parasitoid_line)+ ## hamiltonella lines have a random effect nested by parasitoid origin
       (1|replicate_fullID), ## not changing much
       #(1|Block) + ## block effect is not valid since it's confounded with parasitoid line
     family="binomial"),
  data=data,
  chains=4, iter=2000, seed=666,
  prior=prior,
  backend="rstan" ## better with "cmdstandr", but rtan does the job as well
)

save(list=c("mod"), file=here("R_output","mod_noOLRE.Rdata"))
}

```

Let's check the fitting of the model and prediction vs observed distribution:

```{r pp_check}
pp_check(mod)
pp_check(mod,"stat_2d")
```

Not good fit of predictions, clear overdispersion.
We also have too low prediction of 0, but this is more likely the result of the overdispersion than actual zero-inflation


## Model 2: with OLRE

Let's try with OLRE:

```{r mod}
if(file.exists(here("R_output","mod_OLRE.Rdata"))){
  load(here("R_output","mod_OLRE.Rdata"))
  }else
    {
modOLRE <- brm(
  bf(Mummies_amount|trials(Nymphs_corrected)~
       0+Wasp_host_species+Wasp_host_species:Hamiltonella_host_species+ ## origin in the wild are fixed effects
       (Hamiltonella_host_species|Parasitoid_line)+ ## parasitoid lines have a random effect nested by hamiltonella origin
       (0+Aphid_line|Parasitoid_line)+ ## hamiltonella lines have a random effect nested by parasitoid origin
       (1|replicate_fullID)+ ## not changing much
       #(1|Block) #+ ## block effect is not valid since it's confounded with parasitoid line
       (1|observation), ## this is the OLRE
     family="binomial"),
  data=data,
  chains=4, iter=2000, seed=666,
  prior=prior,
  ### control=list(adapt_delta=0.9),
  ### https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
  ### https://mc-stan.org/users/documentation/case-studies/divergences_and_bias.html
  ###
  backend="rstan" ## better with "cmdstandr", but rtan does the job as well
)


save(list=c("modOLRE"), file=here("R_output","mod_OLRE.Rdata"))
}

```

```{r pp_check_bis}
pp_check(modOLRE)
pp_check(modOLRE,"stat_2d")
```
Ok, that's better

# Plots and postprocessing

## Plots

Let's plot data and make comparisons based on the OLRE model

Predictions base on fixed effects only:

```{r fits_fix}
fits<-data %>% 
  select(Hamiltonella_host_species,Wasp_host_species,
         Origin_ham,Origin_para) %>% 
  distinct() %>% 
  mutate(Nymphs_corrected=1) %>% 
  add_fitted_draws(modOLRE,re_formula = NA) %>%
  ungroup()  
```

Table of observed parasitism success means of parasitoid lines x aphids lines combinations

```{r lines_means}
obsmeans<-data %>% 
  group_by(Hamiltonella_host_species,
           Wasp_host_species,
           Origin_ham,Origin_para,
           Parasitoid_line,Aphid_line) %>% 
  summarise(mean_obs=mean(Mummies_amount/Nymphs_corrected,na.rm=TRUE),
            sd_obs=sd(Mummies_amount/Nymphs_corrected,na.rm=TRUE),
            N_obs=sum(Nymphs_corrected)) %>% 
  ungroup()
```

Plot

```{r plot_v1}
ggplot(fits)+
  geom_boxplot(data=data,
              aes(Origin_ham,
                  Mummies_amount/Nymphs_corrected,
                  group=paste(Aphid_line,Parasitoid_line),
                  col=Aphid_line),
              alpha=0.3)+
  stat_eye(aes(Origin_ham,.value),
           normalize="xy",
           .width=c(0.001,0.95),slab_alpha=0.5)+
  scale_x_discrete("*Hamiltonella* source")+
  scale_y_continuous("Proportion of nymphs parasitized")+
  facet_wrap(~Origin_para) +
  theme(
        #legend.position = "none",
        strip.text = element_markdown(),
        axis.text.x = element_markdown(),
        axis.title.x= element_markdown())
```


```{r plot_v2}
ggplot(fits)+
  geom_jitter(data=obsmeans,
              aes(Origin_ham,
                  mean_obs),
              height=0,width=0.25,
              size=2,alpha=0.7)+
  stat_eye(aes(Origin_ham,.value),
           normalize="xy",
           .width=c(0.001,0.95),slab_alpha=0.5)+
  scale_x_discrete("*Hamiltonella* source")+
  scale_y_continuous("Proportion of nymphs parasitized")+
  facet_wrap(~Origin_para) +
  theme(
        #legend.position = "none",
        strip.text = element_markdown(),
        axis.text.x = element_markdown(),
        axis.title.x= element_markdown())
```

Re-do fits, but scaled to the parasitism success of each wasp line against the defense-free aphids

```{r fits_fix}
translate=data %>% 
  select(Origin_ham,Origin_para,Hamiltonella_host_species,Wasp_host_species) %>% 
  distinct()

fits_scaled<-data %>% 
  select(Hamiltonella_host_species,Wasp_host_species,
         Origin_ham,Origin_para) %>% 
  distinct() %>% 
  mutate(Nymphs_corrected=1) %>% 
  add_fitted_draws(modOLRE,re_formula = NA, scale="linear") %>%
  ungroup() %>% 
  group_by(Wasp_host_species) %>% 
  compare_levels(.value,by=Hamiltonella_host_species, comparison = "control") %>%
  mutate(Hamiltonella_host_species= str_remove(Hamiltonella_host_species, " - none"))%>% 
  left_join(translate)

fits_scaled_probs<-fits_scaled %>% 
  mutate(.value= (exp(.value)/(1+exp(.value))))

```

Scaled plot

```{r plot_scaled}
ggplot(fits_scaled)+
  stat_eye(aes(Origin_ham,.value),
           normalize="xy",
           .width=c(0.001,0.95),slab_alpha=0.5)+
  geom_hline(yintercept = 0, lty=2)+
  scale_x_discrete("*Hamiltonella* source")+
  scale_y_continuous("Relative parasitism success")+
  facet_wrap(~Origin_para) +
  theme(
        #legend.position = "none",
        strip.text = element_markdown(),
        axis.text.x = element_markdown(),
        axis.title.x= element_markdown())
```
```{r plot_scaled_probs}
ggplot(fits_scaled_probs)+
  stat_eye(aes(Origin_ham,.value),
           normalize="xy",
           .width=c(0.001,0.95),slab_alpha=0.5)+
  geom_hline(yintercept = 0.5, lty=2)+
  scale_x_discrete("*Hamiltonella* source")+
  scale_y_continuous("Relative parasitism success")+
  facet_wrap(~Origin_para) +
  theme(
        #legend.position = "none",
        strip.text = element_markdown(),
        axis.text.x = element_markdown(),
        axis.title.x= element_markdown())
```

## Pairwise comparisons


Extract the modeled pairwise differences between treatments/variables

```{r pairwise_diff}
## Differences between parasitoid origins (host), by hamiltonella origin (original host)
fits %>% 
  mutate(.iteration=.draw) %>% 
  group_by(Hamiltonella_host_species) %>% 
  compare_levels(.value,by=Wasp_host_species) %>% 
  mean_hdi(.value) %>%   ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.value=round(.value, digits = 2)) %>% 
  mutate(.value = cell_spec(.value, color=ifelse(.value > 0 & .lower>0, "green", ifelse(.value<0 & .upper<0, "red", "black"))))%>% ## color postive and negative values that do not overlap the zero
    kbl(booktabs = T, linesep = "", escape=FALSE) %>%
  kable_paper("striped",full_width = F) %>%
  scroll_box(width = "100%", height = "300px")



## Differences between hamiltonella origins, par parasitoid origin
fits %>% 
  mutate(.iteration=.draw) %>% 
  group_by(Wasp_host_species) %>% 
  compare_levels(.value,by=Hamiltonella_host_species) %>% 
  mean_hdi(.value) %>%   ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.value=round(.value, digits = 2)) %>% 
  mutate(.value = cell_spec(.value, color=ifelse(.value > 0 & .lower>0, "green", ifelse(.value<0 & .upper<0, "red", "black"))))%>% 
    kbl(booktabs = T, linesep = "", escape=FALSE) %>%
  kable_paper("striped",full_width = F) %>%
  scroll_box(width = "100%", height = "300px")



## All pairwise differences between all combinations of hamiltonella origin x parasitoid origin
fits %>% 
  mutate(.iteration=.draw) %>% 
  mutate(combo=interaction(Wasp_host_species,Hamiltonella_host_species)) %>% 
  compare_levels(.value,by=combo) %>% 
  mean_hdi(.value) %>%   ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.value=round(.value, digits = 2)) %>% 
  mutate(.value = cell_spec(.value, color=ifelse(.value > 0 & .lower>0, "green", ifelse(.value<0 & .upper<0, "red", "black"))))%>% 
    kbl(booktabs = T, linesep = "", escape=FALSE) %>%
  kable_paper("striped",full_width = F) %>%
  scroll_box(width = "100%", height = "300px")


```

## Pairwise comparisons, but grouping by other variables than fixed effects (random effects)

```{r fits_RE}
fitsRE<-data %>% 
  select(Hamiltonella_host_species,Wasp_host_species,
         Origin_ham,Origin_para,
         Aphid_line,Parasitoid_line) %>% ## we include "lineage" variables for aphids (hamiltonella) and parasitoids
  distinct() %>% 
  mutate(Nymphs_corrected=1) %>% 
  add_fitted_draws(modOLRE,
                   re_formula = ~(Hamiltonella_host_species|Parasitoid_line)+
                     (0+Aphid_line|Parasitoid_line)) %>% # we do not include random effects at a level below lineages
  ungroup()
```

```{r}
left_join(obsmeans,fitsRE) %>% 
  ggplot()+
  stat_pointinterval(aes(mean_obs,.value),
                     .width=c(0.001,0.95))+
  scale_x_continuous("observed mean proportion")+
  scale_y_continuous("predicted mean proportion")+
  geom_abline(intercept=0,slope=1)
```


```{r}
fitsRE %>% 
  mutate(.iteration=.draw) %>% 
  group_by(Aphid_line) %>% 
  compare_levels(.value,by=Parasitoid_line) %>% 
  mean_hdi(.value) %>%   ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.value=round(.value, digits = 2)) %>% 
  mutate(.value = cell_spec(.value, color=ifelse(.value > 0 & .lower>0, "green", ifelse(.value<0 & .upper<0, "red", "black"))))%>% 
    kbl(booktabs = T, linesep = "", escape=FALSE) %>%
  kable_paper("striped",full_width = F) %>%
  scroll_box(width = "100%", height = "300px")
```

