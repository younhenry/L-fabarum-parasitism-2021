---
title: "Analysis of parasitoid performance vs transfected lineages of *Hamiltonella*-protected aphids"
date: ""
editor_options:
  chunk_output_type: inline
output:
  html_document:
    theme: yeti
    toc: yes
    toc_float: yes
authors: Youn Henry & Maxime Dahirel
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
```


# Packages

```{r load-packages}
# [R v4.2.1]

library(tidyverse) # CRAN v1.3.1

# there is a known but (as of July 2022) not yet corrected weird dbplyr-related error if brms is loaded *before* the tidyverse
# no issue at all if loaded after
library(cmdstanr) # [github::stan-dev/cmdstanr] v0.5.2
library(brms) # CRAN v2.17.0

library(bayesplot) # CRAN v1.9.0
library(tidybayes) # CRAN v3.0.2

library(patchwork) # CRAN v1.1.1
library(ggtext) # CRAN v0.1.1

library(kableExtra) # CRAN v1.3.4

library(ggh4x) # [github::teunbrand/ggh4x] v0.2.1 ## used for facet_nested in second bubbleplot

library(here) # CRAN v1.0.1

options(mc.cores = 4) ## reduce/increase depending on cores available
```

# Overview

## Loading the data

```{r load-data}
raw_data <- read.table(here("data", "data_parasitism_R.txt"), h = T, dec = ".")

head(raw_data)
```

this dataset contains all the information about the experiments themselves. One row = one trial where one parasitoid was left with aphids to see how many it could parasite:


- `Aphid_line`: ID of the experimental aphid line (to be more accurate, ID codes actually refer to the *Hamiltonella* lines transferred to "standardized" lab aphids). The NTR-407 line is a control with no *Hamiltonella*;
- `Replicate`: each transfected *Hamiltonella* strain was transferred to multiple aphid clonal replicates for replication; this is their ID (needs to be be nested in `Aphid_line`) ;

- `Parasitoid_line`: ID of the focal parasitoid line. One line = one sample from the field (see map);
- `Wasp_genotype`: `Parasitoid_line`s were genotyped, and some belong to the same genotype (see "generalists" on map). This is the corresponding genotype ID;

- `Wasp_host_species` and `Hamiltonella_host_species`: the aphid species in which the focal wasp or *Hamiltonella* strain was found;

- `Block`: temporal experimental unit/block. Unused in analysis, as it is fully confounded with `Parasitoid_line` (each line was done at once, lines were spread in time), and so partly with `Wasp_genotype` (but not with `Wasp_host_species` and `Hamiltonella_host_species`, the actual key variables of interest);

- `Latitude_wasp` and `Longitude_wasp`: where does the wasp `Parasitoid_line` comes from? (see also info in `script_mapping_samples_rmd.Rmd` file)

- `Nymphs_corrected`: the total number of aphid nymphs effectively available to the focal parasitoid in a given assay;
- `Dead_wasp`: whether or not the introduced wasp was dead at the end of the experiment (not used);
- `Mummies_amount`:  the number of `Nymphs_corrected` that were mummified, i.e. in which an egg laid by the introduced wasp managed to develop;
- `Hatching_wasps`:  the number of adult wasps hatching from mummies. Not a reliably taken measure for various reasons; therefore we use `Mummies_amount` as a measure of parasitoid performance 

```{r load-metadata}
data_parasitoids <- read.table(here("data", "parasitoid_samples_2020.txt"),
  h = T, dec = "."
)
```

This dataset contains some metadata-like info about the parasitoid lines used in the experiment (where they were collected, on what... see `script_mapping_samples_rmd.Rmd` file for info).

## Prepping the data

We had to remove one entire aphid line from the loaded raw data, as we realized with sequencing that this line was not the one we expected but was identical to another one (TR-0619).
We also remove 4 rows (out of >1800) scored `NA` due to experimental error (e.g. missing parasitoid).
Then we create a full ID for the aphid lines replicates

```{r prep-data1}
data <- na.omit(raw_data) %>%
  filter(Aphid_line != "TR-0191") %>%
  mutate(
    replicate_fullID = paste(Aphid_line, Replicate)
  )
```

From there we continue by converting aphid and parasitoid line-level info to factor, and re-order the factor levels in a custom way that's visually appealing for some plots:

```{r prep-data2}
## tinkering better order of wasps for plotting
order.origin <- c(
  "Aphis_urticata", "Aphis_ruborum", "Aphis_fabae_fabae",
  "Aphis_hederae"
)

data <- data %>%
  mutate(Wasp_host_species = factor(Wasp_host_species,
    levels = order.origin
  ))

order.genotypes <- as.factor(c(
  12, 11, 3, 15, 18, 19, 16, 17, 14, 13, 6, 8, 7,
  1, 9, 2, 10, 5, 4
))


data <- data %>%
  mutate(
    Hamiltonella_host_species = factor(Hamiltonella_host_species,
      levels = c("none", order.origin)
    ),
    Parasitoid_line = factor(Parasitoid_line),
    Aphid_line = factor(Aphid_line)
  )
```

## Some data relabelling

We are going to slightly relabel some variables so that the values are more plot-friendly (no underscores, added italics for species names using `ggtext`...). We also reorder levels so that the no-Hamiltonella controls are the first levels in their corresponding factor variables

```{r relabel-data}

data <- data %>%
  ## create origin columns with no underscore for good looking plots
  ## and species names we will be able to display
  ## in italic using the markdown facilities in ggtext
  mutate(
    Origin_para = str_replace_all(Wasp_host_species, "_", " "),
    Origin_ham = str_replace_all(Hamiltonella_host_species, "_", " ")
  ) %>%
  mutate(
    Origin_para = str_replace_all(Origin_para, "Aphis", "A."),
    Origin_ham = str_replace_all(Origin_ham, "Aphis", "A.")
  ) %>%
  mutate(
    Origin_para = paste("*", Origin_para, "*", sep = ""),
    Origin_ham = paste("*", Origin_ham, "*", sep = "")
  ) %>%
  mutate(Origin_ham = fct_recode(Origin_ham, `no *H. defensa*` = "*none*")) %>%
  ## we finish by ensuring the no-Ham control is the first level for both
  ## Aphid_line and host_origin variables, for the model
  mutate(
    Aphid_line = fct_relevel(Aphid_line,
      "NTR-407",
      after = 0
    ),
    Hamiltonella_host_species = fct_relevel(factor(Hamiltonella_host_species),
      "none",
      after = 0
    ),
    Origin_ham = fct_relevel(
      factor(Origin_ham),
      "no *H. defensa*",
      "*A. urticata*",
      "*A. ruborum*",
      "*A. fabae fabae*",
      "*A. hederae*"
    ),
    Origin_para = fct_relevel(
      factor(Origin_para),
      "*A. urticata*",
      "*A. ruborum*",
      "*A. fabae fabae*",
      "*A. hederae*"
    )
  ) %>%
  mutate(Origin_para2 = interaction("Parasitoid original host: ",
    Origin_para,
    sep = ""
  )) %>%
  mutate(Origin_ham2 = interaction("*H. defensa* original host: ",
    Origin_ham,
    sep = ""
  )) %>%
  mutate(Origin_ham2 = fct_recode(Origin_ham2,
    `no *H. defensa*` = "*H. defensa* original host: no *H. defensa*"
  ))
```


## "preliminary" visualisations


### Parasitism success, bubble plots

To have a rough look at how parasitism success is distributed among line combinations, we can build some bubble-like plots.

We start by making a summary object that contains the mean parasitism success per strain combo (*Hamiltonella* x parasitoid):

```{r lines-means}
obsmeans <- data %>%
  group_by(
    Hamiltonella_host_species,
    Wasp_host_species,
    Origin_ham, Origin_para, Origin_para2,
    Wasp_genotype, Parasitoid_line, Aphid_line, Origin_ham2
  ) %>%
  summarise(
    mean_success_obs = mean(Mummies_amount / Nymphs_corrected, na.rm = TRUE),
    sd_obs = sd(Mummies_amount / Nymphs_corrected, na.rm = TRUE),
    N_obs = sum(Nymphs_corrected)
  ) %>%
  ungroup()
```


```{r color-code}
colors_wasp <- c(
  Aphis_urticata = "#ff9900",
  Aphis_ruborum = "#88ff4d",
  Aphis_fabae_fabae = "#66ccff",
  Aphis_hederae = "#aa80ff"
)

colors_wasp2 <- c(
  `*A. urticata*` = "#ff9900",
  `*A. ruborum*` = "#88ff4d",
  `*A. fabae fabae*` = "#66ccff",
  `*A. hederae*` = "#aa80ff"
)

colors_aphid <- c(
  none = "black",
  Aphis_urticata = "#ff9900",
  Aphis_ruborum = "#88ff4d",
  Aphis_fabae_fabae = "#66ccff",
  Aphis_hederae = "#aa80ff"
)
```


```{r overlook-bubbleplot}
ggSize <- 0.25
bubbles <- ggplot(data = NULL, aes(Parasitoid_line, Aphid_line)) +
  geom_point(
    data = obsmeans,
    aes(size = mean_success_obs * 25, color = Wasp_host_species),
    shape = 16
  ) + ## adjust size to frequency
  geom_text(
    data = obsmeans[obsmeans$mean_success_obs >= 0.01, ],
    aes(label = round(mean_success_obs * 100, 0)),
    size = 3.5
  ) +
  scale_shape_identity() +
  scale_size_identity() + ## do not plot zero frequency
  scale_colour_manual(values = colors_wasp) + ## define custom colors for protected and unprotected
  labs(title = NULL, x = "Parasitoid line", y = "Aphid line") +
  theme(legend.position = "none") +
  theme(
    strip.text.y = element_markdown(angle = 0),
    strip.text.x = element_markdown(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none",
    axis.title.y = element_text(size = 10),
    axis.title.x = element_text(size = 10, vjust = -1),
    axis.text.x = element_text(angle = 90, size = 10, colour = "black"),
    axis.text.y = element_text(size = 10, colour = "black"),
    axis.ticks = element_line(size = ggSize),
    axis.line = element_line(size = ggSize, colour = "black")
  )

bubbles +
  facet_grid(
    rows = vars(fct_rev(Origin_ham)),
    cols = vars(Origin_para),
    scales = "free", space = "free"
  )

if (file.exists(here("R_output", "Plot_bubbles.pdf"))) {

} else {
  pdf(height = 4, width = 10, file = here("R_output", "Plot_bubbles.pdf"))
  bubbles
  dev.off()
}
```


```{r prep-bubble2}
## bubble plot

order.wasps.genotype <- c(
  "Yp20-027", "Yp20-004", "Yp20-058", "Yp20-075",
  "Yp20-081", "S251", "Yp20-070", "Yp20-003",
  "Yp20-021", "Yp20-044", "Yp20-055", "Yp20-072",
  "Yp20-080", "Yp20-038", "Yp20-006", "Yp20-013",
  "Yp20-035", "Yp20-009", "Yp20-079", "Yp20-037",
  "Yp20-050", "Yp20-060", "Yp20-068", "Yp20-084",
  "F316", "G339", "G363", "G392", "S350", "Yp20-032",
  "Yp20-002", "Yp20-033", "Yp20-048", "Yp20-063",
  "Yp20-071"
)

## get the information on which genotype is generalist or specialist from the data_parasitoids table

niche_info <- data_parasitoids %>%
  select(Wasp_genotype = genotype, niche) %>%
  distinct()

obsmeans2 <- obsmeans %>%
  left_join(niche_info) %>%
  mutate(
    Parasitoid_line = factor(Parasitoid_line,
      levels = order.wasps.genotype
    ),
    Wasp_genotype = factor(Wasp_genotype,
      levels = order.genotypes
    ),
    Wasp_host_species = factor(Wasp_host_species,
      levels = order.origin
    ),
    niche = factor(niche, levels = c("generalist", "specialist"))
  ) %>%
  arrange(Wasp_host_species) %>%
  arrange(Wasp_genotype) %>%
  arrange(niche)
```


```{r overlook-bubbleplot2}
ggSize <- 0.25
bubbles_genotype <- ggplot(data = NULL, aes(Parasitoid_line, Aphid_line)) +
  geom_point(
    data = obsmeans2,
    aes(size = mean_success_obs * 25, color = Wasp_host_species),
    shape = 16
  ) + ## adjust size to frequency
  geom_text(
    data = obsmeans2[obsmeans2$mean_success_obs >= 0.01, ],
    aes(label = round(mean_success_obs * 100, 0)),
    size = 3.5
  ) +
  scale_shape_identity() +
  scale_size_identity() + ## do not plot zero frequency
  scale_colour_manual(values = colors_wasp) + ## define custom colors for protected and unprotected
  labs(title = NULL, x = "Parasitoid line", y = "Aphid line") +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off") +
  ## geom_hline(yintercept=1.5,lwd=ggSize)+
  theme(
    strip.text.y = element_markdown(angle = 0),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.margin = margin(5.5, 5.5, 5.5, 5.5, "points"),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_text(size = 12, vjust = -1),
    axis.text.x = element_text(
      angle = 90, size = 10,
      colour = "black", vjust = 0.4, hjust = 1
    ),
    axis.text.y = element_text(size = 10, colour = "black"),
    axis.ticks = element_line(size = ggSize),
    axis.line = element_line(size = ggSize, colour = "black")
  )

bubbles_genotype +
  facet_nested(fct_rev(Origin_ham) ~ niche + Wasp_genotype,
    scales = "free", space = "free",
    nest_line = element_line(),
    strip = strip_nested(
      by_layer_x = TRUE,
      background_x = elem_list_rect(
        fill = c("white", "grey85")
      )
    )
  )

if (file.exists(here("R_output", "Plot_bubbles_genotype.pdf"))) {

} else {
  pdf(
    height = 4, width = 11,
    file = here("R_output", "Plot_bubbles_genotype.pdf")
  )
  bubbles_genotype
  dev.off()
}
```



# Models with bayesian approach

## Priors

We are going to use generic weakly informative priors inspired from McElreath (2020):

```{r prior}

prior <- c(
  set_prior("normal(0,1)", class = "b"), # can be improved
  set_prior("normal(0,1.5)",
    class = "b", # specific priors for parameters interpretable as the logit of an actual proportion
    # i.e. wasp-Origin-specific intercepts
    coef = c(
      "Wasp_host_speciesAphis_fabae_fabae",
      "Wasp_host_speciesAphis_hederae",
      "Wasp_host_speciesAphis_ruborum",
      "Wasp_host_speciesAphis_urticata"
    )
  ),
  set_prior("normal(0,1)", class = "sd"), # can be replaced by exponential(1) (larger)
  set_prior("lkj(2)", class = "cor") ## correlations between random effects
  # can loosen that prior with lkj(1)
)
```

## Model 1

Let's start with a simple binomial model:


```{r mod-binomial}
if (file.exists(here("R_output", "mod_binom.Rdata"))) {
  # this if-else statement is avoid re-fitting a model if there is already one existing in R_output
  # to override, re-run the model and re-save manually by selecting only the relevant code lines (or delete the Rdata object before relaunching this code chunk)
  load(here("R_output", "mod_binom.Rdata"))
} else {
  mod_binom <- brm(
    bf(Mummies_amount | trials(Nymphs_corrected) ~
      0 + Wasp_host_species + Wasp_host_species:Hamiltonella_host_species + ## origin in the wild are fixed effects
      (Aphid_line | Wasp_genotype) + ## but more generally, each wasp genotype has its own, random effect response to each Hamiltonella line
      (1 | replicate_fullID), ## random effect of the replicate inside each aphid line (not changing much)
    # (1|Block) #+ ## block effect is not valid since it's confounded with parasitoid line
    ## (see: data %>% select(Parasitoid_line,Block) %>% distinct() %>% table())
    family = "binomial"
    ),
    data = data,
    chains = 4, iter = 2000, seed = 666,
    prior = prior,
    backend = "cmdstanr"
  )

  save(list = c("mod_binom"), file = here("R_output", "mod_binom.Rdata"))
}
```

Let's check the fit of the model by comparing predicted vs observed distribution:

```{r pp-check}
pp_check(mod_binom)
pp_check(mod_binom, "stat_2d")
```

Not good fit of predictions, clear overdispersion.
We also have too low prediction of 0, but this is more likely the result of the overdispersion than actual zero-inflation.
At least, let's try to remedy the overdispersion before worrying about zero-inflation.
To do that, let's use a beta-binomial model


## Model 2: beta-binomial

```{r mod-betabinomial}
if (file.exists(here("R_output", "mod_betabinom.Rdata"))) {
  # this if-else statement is avoid re-fitting a model if there is already one existing in R_output
  # to override, re-run the model and re-save manually by selecting only the relevant code lines (or delete the Rdata object before relaunching this code chunk)
  load(here("R_output", "mod_betabinom.Rdata"))
} else {
  mod_betabinom <- brm(
    bf(Mummies_amount | trials(Nymphs_corrected) ~
      0 + Wasp_host_species + Wasp_host_species:Hamiltonella_host_species +
      (Aphid_line | Wasp_genotype) +
      (1 | replicate_fullID),
    nlf(phi ~ 1 / invphi),
    # easier to set priors on 1/phi than phi
    # see https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations#story-when-the-generic-prior-fails-the-case-of-the-negative-binomial
    invphi ~ 1,
    family = beta_binomial(link_phi = "identity")
    ),
    data = data,
    chains = 4, iter = 2000, seed = 666,
    prior = c(
      prior,
      set_prior("normal(0,1)", nlpar = "invphi", lb = 0) # half-normal prior on 1/phi
    ),
    backend = "cmdstanr"
  )

  save(
    list = c("mod_betabinom"),
    file = here("R_output", "mod_betabinom.Rdata")
  )
}
```


```{r pp-check-bis}
pp_check(mod_betabinom)
pp_check(mod_betabinom, "stat_2d")
```

That's better!

### A note

One may have noted that we used `Wasp_genotype` (which reflects the outcome of line genotyping) as a random effect, rather than `Parasitoid_line` (some genotypes have been sampled in multiple places, and so are in multiple lines). This is a choice made to be congruent with the `Aphid_line` side of the random effect, as all *Hamiltonella* lines are genetically distinct. Nonetheless, one may want to re-run the models above using `Parasitoid_line`. We don't present it in detail here, for clarity, but it is as simple as replacing `(Aphid_line | Wasp_genotype)` by `(Aphid_line | Parasitoid_line)` in the models above. Doing that and then running all the code downstream of the models (while changing model and variable names as needed) shows that this leads to qualitatively identical outcomes.

### Model comparison using LOO/Kfold

We can also directly compare the models using LOO

```{r loo}
loo_binom <- loo(mod_binom)
loo_betabinom <- loo(mod_betabinom)

loo_compare(loo_binom, loo_betabinom)
```

If you look at the details of the `loo_binom` object you will see that the Pareto k diagnostics flag some observations as "bad" or "very bad" which may lead to inaccurate estimate of the LOO metrics. Ideally, we should try to correct that using moment matching methods (but they are not well implemented using cmdstanr), or by using K-fold cross-validation instead of Leave One Out. To do K-fold CV one needs to refit each model K times (default 10) which may take a lot of time (around one hour each), and in the present case, model comparison using LOO and K-fold gives the same message. So the code for K-fold below is silenced out to save time, only run it if you really want/need to check these K-fold values.

```{r kfold}
#if (file.exists(here("R_output", "Kfold_models.Rdata"))) {
#  load(here("R_output", "Kfold_models.Rdata"))
#} else {
#kfold_binom <- kfold(mod_binom)  # default k fold is 10
#kfold_betabinom <- kfold(mod_betabinom)
# save(
#    list = c("kfold_binom","kfold_betabinom"),
#    file = here("R_output", "Kfold_models.Rdata")
#  )
#}
#
#loo_compare(kfold_binom, kfold_betabinom)
```

Now that we have a preferred model, we can move to the next steps.

# Plots and postprocessing

Let's plot data and make comparisons based on the beta-binomial model

## Parasitoid performance plots

We generate predictions based on fixed effects only:

```{r fits-fix}
fits <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para, Origin_para2, Origin_ham2
  ) %>%
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_epred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup()
```

Then we make the plots

```{r aphidline-colors}
# not used for now
colors_aphid_lines <- c(
  `NTR-407` = "black",
  `TR-0016` = "#ffc266",
  `TR-0042` = "#4dc3ff",
  `TR-0076` = "#00a0f0",
  `TR-0103` = "#e68a00",
  `TR-0131` = "#995c00",
  `TR-0214` = "#9966ff",
  `TR-0244` = "#5c0aff",
  `TR-0619` = "#53c71a"
)
```

Here we have a plot showing the observed (boxplot) and predicted (eye) performance of parasitoids as a fonction of host origin

```{r plot-v1}
data <- data %>%
  arrange(Aphid_line) %>%
  arrange(Origin_ham) %>%
  arrange(Origin_para)

fits <- fits %>%
  arrange(Origin_ham2)

plot_v1 <- ggplot(fits) +
  geom_boxplot(
    data = data,
    aes(Origin_para,
      Mummies_amount / Nymphs_corrected,
      group = paste(Aphid_line, Parasitoid_line),
      color = Origin_para
    ),
    alpha = 0.3
  ) +
  stat_eye(aes(Origin_para, .epred),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  scale_x_discrete("*L. fabarum* original host") +
  scale_y_continuous("Proportion of nymphs parasitized") +
  scale_color_manual(values = colors_wasp2) +
  facet_wrap(~ fct_relevel(Origin_ham2, rev), nrow = 5) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown()
  )


if (file.exists(here("R_output", "Parasitism_all_lines_mod_betabinom.pdf"))) {
  plot_v1
} else {
  pdf(height = 8, width = 5, file = here("R_output", "Parasitism_all_lines_mod_betabinom.pdf"))
  plot_v1
  dev.off()
}
```

And the same plot, this time with observed values as dots representing the line combination-level averages

```{r plot-v2}
plot_v2 <- ggplot(fits) +
  geom_jitter(
    data = obsmeans,
    aes(Origin_para,
      mean_success_obs,
      color = Origin_para
    ),
    height = 0, width = 0.2,
    size = 2, alpha = 0.7
  ) +
  stat_eye(aes(Origin_para, .epred),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  scale_x_discrete("*L. fabarum* original host") +
  scale_y_continuous("Proportion of nymphs parasitized") +
  scale_color_manual(values = colors_wasp2) +
  facet_wrap(~ fct_relevel(Origin_ham2, rev), nrow = 5) +
  theme_bw(base_size = 12) +
  theme(panel.grid.minor = element_blank()) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown()
  )


if (
  file.exists(
    here("R_output", "Parasitism_by_ham_origin_mod_betabinom.pdf")
  )
) {
  plot_v2
} else {
  pdf(
    height = 5, width = 4,
    file = here("R_output", "Parasitism_by_ham_origin_mod_betabinom.pdf")
  )
  plot_v2
  dev.off()
}
```

### Relative parasitoid performance plots

We can use the model to build posterior samples of the differences between various treatments, to make plots describing the *relative* parasitism success of each wasp line/type compared to a reference (on the logit link scale).

For instance, relative to their success on the *Hamiltonella* free aphids. We start by creating a table with the predictions, using `compare_levels` to make comparisons to the control

```{r fits-relative-ctrl}
translate <- data %>%
  select(
    Origin_ham, Origin_para, Origin_para2, Hamiltonella_host_species,
    Wasp_host_species, Origin_ham2
  ) %>%
  distinct()

fits_scaled <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2, Origin_ham2
  ) %>%
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup() %>%
  group_by(Wasp_host_species) %>%
  compare_levels(.linpred,
    by = Hamiltonella_host_species, comparison = "control"
  ) %>%
  mutate(Hamiltonella_host_species = str_remove(Hamiltonella_host_species, " - none")) %>%
  left_join(translate) %>%
  arrange(Origin_para) %>%
  arrange(Origin_ham2)
```

Then we make plots

```{r plot-relative-ctrl-by-hamiltonella_origin}

plot_scaled <- ggplot(fits_scaled) +
  stat_eye(aes(Origin_ham, .linpred, fill = Origin_ham),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  geom_hline(yintercept = 0, lty = 2) +
  scale_x_discrete("*H. defensa* origin") +
  scale_y_continuous("Relative parasitism success (vs no *H. defensa*, logit scale)") +
  scale_fill_manual(values = colors_wasp2) +
  facet_wrap(~ fct_relevel(Origin_para2, rev), nrow = 4) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown()
  )

if (
  file.exists(
    here("R_output", "Relative_parasitism_all_lines_mod_betabinom.pdf")
  )
) {
  plot_scaled
} else {
  pdf(
    height = 4, width = 4,
    file = here("R_output", "Relative_parasitism_all_lines_mod_betabinom.pdf")
  )
  plot_scaled
  dev.off()
}
```

```{r plot-relative-ctrl-by-wasp_origin}
plot_scaled2 <- ggplot(subset(fits_scaled, fits_scaled$Hamiltonella_host_species != "none")) +
  stat_eye(aes(Origin_para, .linpred, fill = Origin_para),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  geom_hline(yintercept = 0, lty = 2) +
  scale_x_discrete("*L. fabarum* original host") +
  scale_y_continuous("Relative parasitism success (vs no *H. defensa*, logit scale)") +
  scale_fill_manual(values = colors_wasp2) +
  facet_wrap(~ fct_relevel(Origin_ham2, rev), nrow = 4) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown()
  )

if (
  file.exists(
    here("R_output", "Relative_parasitism_all_lines_by_ham_mod_betabinom.pdf")
  )
) {
  plot_scaled2
} else {
  pdf(
    height = 6, width = 4,
    file = here("R_output", "Relative_parasitism_all_lines_by_ham_mod_betabinom.pdf")
  )
  plot_scaled2
  dev.off()
}
```

Similar to the above, a way to explore whether there is local adaptation is to compare, for each parasitoid origin, the predicted performance on aphids with "non-local" *Hamiltonella* (or no *Hamiltonella*) to the predicted performance on aphids with "local" *Hamiltonella*. The code to generate the relevant contrasts is a bit more complex since this time there is no one "control" that works for everything, but the general idea is the same

```{r fits-local-adapt-pool}
fits_logit <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para, Origin_para2, Origin_ham2
  ) %>%
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup() %>%
  mutate(Ham_type = case_when(
    Hamiltonella_host_species == "none" ~ "no *H. defensa*",
    as.character(Hamiltonella_host_species) == as.character(Wasp_host_species) ~ "local",
    TRUE ~ "non-local *H. defensa*"
  )) %>%
  group_by(.draw, Wasp_host_species, Origin_para, Origin_para2, Ham_type) %>%
  summarise(.linpred = mean(.linpred)) %>%
  ungroup() %>%
  group_by(Wasp_host_species, Origin_para, Origin_para2) %>%
  compare_levels(.linpred, by = Ham_type, comparison = "control") %>%
  mutate(Ham_type = str_remove(Ham_type, " - local"))
```


```{r plot-local-adapt-pool}
fits_logit %>%
  ggplot() +
  stat_eye(aes(Ham_type, .linpred, fill = Origin_para),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  scale_fill_manual(values = colors_wasp2) +
  scale_x_discrete("*Hamiltonella defensa* ?") +
  scale_y_continuous("Relative parasitism success (compared to same-origin *H. defensa*, logit scale)") +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~ fct_relevel(Origin_para2, rev), nrow = 4) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown()
  )
```

we can do the same, but without averaging the "non-local" modalities:

```{r fits-local-adapt}
fits_logit2 <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2, Origin_ham2
  ) %>%
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup() %>%
  group_by(Wasp_host_species) %>%
  nest() %>%
  mutate(local_level = map2(
    .x = Wasp_host_species, .y = data,
    .f = ~ .y %>% compare_levels(.linpred,
      by = Hamiltonella_host_species,
      comparison = emmeans_comparison("trt.vs.ctrl", ref = as.character(.x))(unique(.y$Hamiltonella_host_species))
    )
  )) %>%
  select(Wasp_host_species, local_level) %>%
  unnest(local_level) %>%
  ungroup() %>%
  mutate(Hamiltonella_host_species = str_split_fixed(Hamiltonella_host_species, pattern = " - ", n = 2)[, 1])


origin_info <- data %>%
  select(Wasp_host_species, Hamiltonella_host_species, Origin_ham, Origin_para, Origin_para2) %>%
  distinct()
```

This gives a plot that looks slightly different, where all origins are represented, but the one that is collapsed to 0 depends on the focal treatment

```{r plot-local-adapt}
fits_logit2 %>%
  left_join(origin_info) %>%
  ggplot() +
  stat_eye(aes(Origin_ham, .linpred, fill = Origin_para),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  geom_hline(yintercept = 0, lty = 2) +
  scale_x_discrete("*H. defensa* origin") +
  scale_y_continuous("Relative parasitism success (vs \"local\" *H. defensa*, logit scale)") +
  scale_fill_manual(values = colors_wasp2) +
  facet_wrap(~ fct_relevel(Origin_para2, rev), nrow = 4) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown()
  )
```


## Pairwise comparisons

More generally, we may want to extract tables with modeled pairwise differences between any treatments/variables for the Results

```{r pairwise-diff}
## Differences between parasitoid origins (host), by hamiltonella origin (original host)
fits %>%
  mutate(.iteration = .draw) %>%
  group_by(Hamiltonella_host_species) %>%
  compare_levels(.epred, by = Wasp_host_species) %>%
  mean_hdi(.epred) %>% ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.epred = round(.epred, digits = 2)) %>%
  mutate(.epred = cell_spec(.epred,
    color = ifelse(.epred > 0 & .lower > 0, "green",
      ifelse(.epred < 0 & .upper < 0,
        "red", "black"
      )
    )
  )) %>% ## color postive and negative values that do not overlap the zero
  kbl(booktabs = T, linesep = "", escape = FALSE) %>%
  kable_paper("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "300px")



## Differences between hamiltonella origins, par parasitoid origin
fits %>%
  mutate(.iteration = .draw) %>%
  group_by(Wasp_host_species) %>%
  compare_levels(.epred, by = Hamiltonella_host_species) %>%
  mean_hdi(.epred) %>% ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.epred = round(.epred, digits = 2)) %>%
  mutate(.epred = cell_spec(.epred,
    color = ifelse(.epred > 0 & .lower > 0, "green",
      ifelse(.epred < 0 & .upper < 0,
        "red", "black"
      )
    )
  )) %>%
  kbl(booktabs = T, linesep = "", escape = FALSE) %>%
  kable_paper("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "300px")



## All pairwise differences between all combinations of hamiltonella origin x parasitoid origin
fits %>%
  mutate(.iteration = .draw) %>%
  mutate(combo_wasp.ham = interaction(
    Wasp_host_species,
    Hamiltonella_host_species
  )) %>%
  compare_levels(.epred, by = combo_wasp.ham) %>%
  mean_hdi(.epred) %>% ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.epred = round(.epred, digits = 2)) %>%
  mutate(.epred = cell_spec(.epred,
    color = ifelse(.epred > 0 & .lower > 0, "green",
      ifelse(.epred < 0 & .upper < 0,
        "red", "black"
      )
    )
  )) %>%
  kbl(booktabs = T, linesep = "", escape = FALSE) %>%
  kable_paper("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "300px")
```

## Predicted vs observed comparison

To determine whether the beta-binomial model predicts well the expected line/genotype level parasitism success, we can re-do the predictions, this time including the relevant aphid and parasitoid random effects:

```{r fits-with-RE}

fitsRE <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2,
    Aphid_line, Wasp_genotype
  ) %>% ## we include "lineage" variables for aphids (hamiltonella) and parasitoids
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_epred_draws(mod_betabinom,
    re_formula = ~ (Aphid_line | Wasp_genotype)
  ) %>% # we do not include random effects at a level below lineages
  ungroup()
```

And then do a plot showing observed line average vs predicted:

```{r plot-obs-v-pred-line-level}
left_join(obsmeans, fitsRE) %>%
  ggplot() +
  stat_pointinterval(aes(mean_success_obs, .epred),
    .width = c(0.001, 0.95)
  ) +
  scale_x_continuous("observed mean proportion of nymphs parasitized",
    breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)
  ) +
  scale_y_continuous("predicted mean proportion of nymphs parasitized",
    breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)
  ) +
  geom_abline(intercept = 0, slope = 1, lty = 2) +
  theme_bw(base_size = 12) +
  theme(panel.grid.minor = element_blank()) +
  theme(aspect.ratio = 1)
```


# variance partitioning

We may look at how much genotype/strain pair-level variance is due to genotype/strain host origin vs. anything else about the genotype (on the *logit scale*).

we first need to estimate the variance explained by host origin on both the wasp and *Hamiltonella* side, i.e. fixed effects. Simple: we make predictions based on fixed effects only, then estimate their variance (see e.g. Nakagawa & Schielzeth 2013 eqn 27, doi: 10.1111/j.2041-210x.2012.00261.x). Important here: we make these predictions using every point of the original data fed to the model

```{r fixed-effect-variance}
fits_logit_full <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2
  ) %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup()


var_fix <- fits_logit_full %>%
  group_by(.draw) %>%
  summarise(VF = var(.linpred))
```

Now we need to get the variance explained by the *Hamiltonella* and parasitoid line effects. This a bit trickier than simply getting the random effect coefficients, since we have random slopes. We use the method described in Johnson 2014 eqn 11 (doi: 10.1111/2041-210X.12225)

```{r line-ranef-variance}
vc <- VarCorr(mod_betabinom, summary = FALSE)$Wasp_genotype$cov
vc_nested <- tibble(
  varcorr = array_tree(vc, margin = 1),
  design_matrix = rep(list(model.matrix(~Aphid_line, data = data)), dim(vc)[1]),
  .draw = 1:dim(vc)[1]
)

# quick checks that the components are correct
# in particular, check that the coefficients are in the same order in both table (brms has some internal remaing rules for things like underscores...)
# vc_nested$design_matrix[[1]]
# vc_nested$varcorr[[1]]

var_line <- vc_nested %>% # may take some time (a few minutes) to loop through depending on how many posterior samples you have
  mutate(Vline = map2(
    .x = varcorr, .y = design_matrix,
    .f = function(sigma = .x, Z = .y) {
      n = dim(Z)[1]
      ZsZ = Z %*% sigma %*% t(Z)
      Vline <- sum(diag(ZsZ)) / n # trace(M) = sum(diag(M))
      return(Vline)
    }
  )) %>%
  unnest(Vline)
```

For completion, we can also get the variance explained by the technical replicates of the aphid lines

```{r aphid-replicate-line-variance}
var_replicate_aphid <- tibble(Vrep_aphid = (VarCorr(mod_betabinom, summary = FALSE)$replicate_fullID$sd[, 1])^2) %>%
  mutate(.draw = 1:dim(.)[1])
```

```{r varcomps-table}
varcomps <- var_line %>%
  ungroup() %>%
  select(Vline, .draw) %>%
  left_join(var_fix) %>%
  left_join(var_replicate_aphid)
```

that's it! we can plot it

```{r plot-varpart}

ggplot(varcomps) +
  stat_halfeye(aes(VF / (VF + Vline)), .width = c(0.001, 0.95)) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(
    x = "proportion of line-level variation explained by line origin hosts (logit scale)",
    y = ""
  ) +
  theme_bw(base_size = 12) +
  theme(panel.grid.minor = element_blank())
```
