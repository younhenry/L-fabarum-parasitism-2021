---
title: "Analysis of parasitoid performance vs transfected lineages of *Hamiltonella*-protected aphids"
date: ""
editor_options:
  chunk_output_type: inline
output:
  html_document:
    theme: yeti
    toc: yes
    toc_float: yes
authors: Youn Henry & Maxime Dahirel
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
```


# Packages

```{r packages-loading}
                    # [R v4.2.1]

library(tidyverse)  # CRAN v1.3.1

# there is a known but (as of July 2022) not yet corrected weird dbplyr-related error if brms is loaded *before* the tidyverse
# no issue at all if loaded after
library(cmdstanr)   # [github::stan-dev/cmdstanr] v0.5.2
library(brms)       # CRAN v2.17.0

library(bayesplot)  # CRAN v1.9.0
library(tidybayes)  # CRAN v3.0.2

library(patchwork)  # CRAN v1.1.1
library(ggtext)     # CRAN v0.1.1

library(kableExtra) # CRAN v1.3.4
library(viridis)    # CRAN v0.6.2

library(ggh4x)

library(here)       # CRAN v1.0.1

options(mc.cores = 4) ## reduce/increase depending on cores available
```

# Overview

## Loading the data

```{r data-load}
raw_data <- read.table(here("data", "data_parasitism_R.txt"), h = T, dec = ".")

head(raw_data)
```

this dataset contains all the information about the transfection experiments:

- `Replicate`:
- `Aphid_line`:
- `Parasitoid_line`:
- `Block`: 
- `Latitude_wasp` and `Longitude_wasp`:
- `Wasp_host_species` and `Hamiltonella_host_species`:
- `Wasp_genotype`:
- `Nymphs_corrected`:
- `Dead_wasp`:
- `Mummies_amount`:
- `Hatching_wasps`:   

```{r data-load2}
data_parasitoids <- read.table(here("data", "parasitoid_samples_2020.txt"),
  h = T, dec = "."
)
```

This dataset contains some metadata-like info about the parasitoid lines used in the experiment:

- `sample_id`:
- `plant_code` and `plant_species`:
- `latitude` and `longitude`:
- `site`:
- `aphid_species`:
- `genotype`:
- `niche`:


## Prepping the data

We had to remove one entire aphid line from the loaded raw data, as we realized with sequencing that this line was not the one we expected but was identical to another one (TR-0619).
We also remove 4 rows (out of >1800) scored `NA` due to experimental error (e.g. missing parasitoid).
Then we create a full ID for the aphid lines replicates

```{r overlook}
data <- na.omit(raw_data) %>%
  filter(Aphid_line != "TR-0191") %>%
  mutate(
    replicate_fullID = paste(Aphid_line, Replicate)
  )
```

From there we continue by converting aphid and parasitoid line-level info to factor, and re-order the factor levels in a custom way that's visually appealing for some plots:
```{r overlook2}
## tinkering better order of wasps for plotting
order.origin <- c(
  "Aphis_urticata", "Aphis_ruborum", "Aphis_fabae_fabae",
  "Aphis_hederae"
)

data <- data %>%
  mutate(Wasp_host_species = factor(Wasp_host_species,
    levels = order.origin
  ))

order.genotypes <- as.factor(c(
  12, 11, 3, 15, 18, 19, 16, 17, 14, 13, 6, 8, 7,
  1, 9, 2, 10, 5, 4
))


data <- data %>%
  mutate(
    Hamiltonella_host_species = factor(Hamiltonella_host_species,
      levels = c("none", order.origin)
    ),
    Parasitoid_line = factor(Parasitoid_line),
    Aphid_line = factor(Aphid_line)
  )
```

## Some data relabelling

We are going to slightly relabel some variables so that the values are more plot-friendly (no underscores, added italics for species names...). We also reorder levels so that the no-Hamiltonella controls are the first levels in their corresponding factor variables

```{r data-preparation}

data <- data %>%
  #                 # create origin columns with no underscore for good looking plots
  ## and species names we will be able to display
  ## in italic using the markdown facilities in ggtext
  mutate(
    Origin_para = str_replace_all(Wasp_host_species, "_", " "),
    Origin_ham = str_replace_all(Hamiltonella_host_species, "_", " ")
  ) %>%
  mutate(
    Origin_para = str_replace_all(Origin_para, "Aphis", "A."),
    Origin_ham = str_replace_all(Origin_ham, "Aphis", "A.")
  ) %>%
  mutate(Origin_para = paste("*", Origin_para, "*", sep = ""),
         Origin_ham = paste("*", Origin_ham, "*", sep = "")) %>%
  mutate(Origin_ham = fct_recode(Origin_ham, `no *H. defensa*` = "*none*")) %>%
  ## we finish by ensuring the no-Ham control is the first level for both
  ## Aphid_line and host_origin variables, for the model
  mutate(
    Aphid_line = fct_relevel(Aphid_line,
      "NTR-407",
      after = 0
    ),
    Hamiltonella_host_species = fct_relevel(factor(Hamiltonella_host_species),
      "none",
      after = 0
    ),
    Origin_ham = fct_relevel(factor(Origin_ham),
      "no *H. defensa*","*A. urticata*","*A. ruborum*","*A. fabae fabae*","*A. hederae*"
    ),
    Origin_para = fct_relevel(factor(Origin_para),
      "*A. urticata*","*A. ruborum*","*A. fabae fabae*","*A. hederae*"
    )
  ) %>%
  mutate(Origin_para2 = interaction("Parasitoid original host: ",
    Origin_para,
    sep = ""
  )) %>%
  mutate(Origin_ham2 = interaction("*H. defensa* original host: ",
    Origin_ham,
    sep = "")
  ) %>% 
  mutate(Origin_ham2 = fct_recode(Origin_ham2, `no *H. defensa*` = "*H. defensa* original host: no *H. defensa*"))
```


## "preliminary" visualisations


### Parasitism success, bubble plots

To have a rough look at how parasitism success is distributed among line combination, we can build some bubble-like plots.

We start by making a summary object that contains the mean parasitism success per strain combo (*Hamiltonella* x parasitoid):

```{r lines_means}
obsmeans <- data %>%
  group_by(
    Hamiltonella_host_species,
    Wasp_host_species,
    Origin_ham, Origin_para, Origin_para2,
    Wasp_genotype, Parasitoid_line, Aphid_line, Origin_ham2
  ) %>%
  summarise(
    mean_success_obs = mean(Mummies_amount / Nymphs_corrected, na.rm = TRUE),
    sd_obs = sd(Mummies_amount / Nymphs_corrected, na.rm = TRUE),
    N_obs = sum(Nymphs_corrected)
  ) %>%
  ungroup()
```


```{r color_code}
colors_wasp <- c(Aphis_urticata="#ff9900", 
                 Aphis_ruborum="#88ff4d", 
                 Aphis_fabae_fabae="#66ccff", 
                 Aphis_hederae="#aa80ff")

colors_wasp2 <- c(`*A. urticata*`="#ff9900", 
                 `*A. ruborum*`="#88ff4d", 
                 `*A. fabae fabae*`="#66ccff", 
                 `*A. hederae*`="#aa80ff")

colors_aphid <- c(none="black",
                  Aphis_urticata="#ff9900", 
                 Aphis_ruborum="#88ff4d", 
                 Aphis_fabae_fabae="#66ccff", 
                 Aphis_hederae="#aa80ff")
```


```{r overlook3}
ggSize <- 0.25
bubbles <- ggplot(data = NULL, aes(Parasitoid_line, Aphid_line)) +
  geom_point(
    data = obsmeans,
    aes(size = mean_success_obs * 25, color = Wasp_host_species),
    shape = 16
  ) + ## adjust size to frequency
  geom_text(
    data = obsmeans[obsmeans$mean_success_obs >= 0.01, ],
    aes(label = round(mean_success_obs * 100, 0)),
    size = 3.5
  ) +
  scale_shape_identity() +
  scale_size_identity() + ## do not plot zero frequency
  scale_colour_manual(values = colors_wasp) + ## define custom colors for protected and unprotected
  labs(title = NULL, x = "Parasitoid line", y = "Aphid line") +
  theme(legend.position = "none") +
  theme(
    strip.text.y = element_markdown(angle=0),
    strip.text.x = element_markdown(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none",
    axis.title.y = element_text(size = 10),
    axis.title.x = element_text(size = 10, vjust = -1),
    axis.text.x = element_text(angle = 90, size = 10, colour = "black"),
    axis.text.y = element_text(size = 10, colour = "black"),
    axis.ticks = element_line(size = ggSize),
    axis.line = element_line(size = ggSize, colour = "black")
  )

bubbles + facet_grid(rows = vars(fct_rev(Origin_ham)), cols=vars(Origin_para),scales = "free",space="free")

if (file.exists(here("R_output", "Plot_bubbles.pdf"))) {

} else {
  pdf(height = 4, width = 10, file = here("R_output", "Plot_bubbles.pdf"))
  bubbles
  dev.off()
}
```


```{r overlook by genotype}
## bubble plot

order.wasps.genotype <- c(
  "Yp20-027", "Yp20-004", "Yp20-058", "Yp20-075",
  "Yp20-081", "S251", "Yp20-070", "Yp20-003",
  "Yp20-021", "Yp20-044", "Yp20-055", "Yp20-072",
  "Yp20-080", "Yp20-038", "Yp20-006", "Yp20-013",
  "Yp20-035", "Yp20-009", "Yp20-079", "Yp20-037",
  "Yp20-050", "Yp20-060", "Yp20-068", "Yp20-084",
  "F316", "G339", "G363", "G392", "S350", "Yp20-032",
  "Yp20-002", "Yp20-033", "Yp20-048", "Yp20-063",
  "Yp20-071"
)

## get the information on which genotype is generalist or specialist from the data_parasitoids table

niche_info <- data_parasitoids %>%
  select(Wasp_genotype = genotype, niche) %>%
  distinct()

obsmeans2 <- obsmeans %>%
  left_join(niche_info) %>%
  mutate(
    Parasitoid_line = factor(Parasitoid_line,
      levels = order.wasps.genotype
    ),
    Wasp_genotype = factor(Wasp_genotype,
      levels = order.genotypes
    ),
    Wasp_host_species = factor(Wasp_host_species,
      levels = order.origin
    ),
    niche = factor(niche, levels = c("generalist", "specialist"))
  ) %>%
  arrange(Wasp_host_species) %>%
  arrange(Wasp_genotype) %>%
  arrange(niche)



ggSize <- 0.25
bubbles_genotype <- ggplot(data = NULL, aes(Parasitoid_line, Aphid_line)) +
  geom_point(
    data = obsmeans2,
    aes(size = mean_success_obs * 25, color = Wasp_host_species),
    shape = 16
  ) + ## adjust size to frequency
  geom_text(
    data = obsmeans2[obsmeans2$mean_success_obs >= 0.01, ],
    aes(label = round(mean_success_obs * 100, 0)),
    size = 3.5
  ) +
  scale_shape_identity() +
  scale_size_identity() + ## do not plot zero frequency
  scale_colour_manual(values = colors_wasp) + ## define custom colors for protected and unprotected
  labs(title = NULL, x = "Parasitoid line", y = "Aphid line") +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off") +
  ## geom_hline(yintercept=1.5,lwd=ggSize)+
  theme(strip.text.y = element_markdown(angle=0),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.margin = margin(5.5, 5.5, 5.5, 5.5, "points"),
    axis.title.y = element_text(size = 12),
    axis.title.x = element_text(size = 12, vjust = -1),
    axis.text.x = element_text(
      angle = 90, size = 10,
      colour = "black", vjust = 0.4, hjust = 1
    ),
    axis.text.y = element_text(size = 10, colour = "black"),
    axis.ticks = element_line(size = ggSize),
    axis.line = element_line(size = ggSize, colour = "black")
  )

bubbles_genotype+ facet_nested(fct_rev(Origin_ham)~ niche + Wasp_genotype,scales = "free",space="free",
                                nest_line = element_line(),
                               strip=strip_nested(by_layer_x = TRUE,
                                                  background_x = elem_list_rect(fill = c("white", "grey85")),
                                                  ))

if (file.exists(here("R_output", "Plot_bubbles_genotype.pdf"))) {

} else {
  pdf(
    height = 4, width = 11,
    file = here("R_output", "Plot_bubbles_genotype.pdf")
  )
  bubbles_genotype
  dev.off()
}
```



# Models with bayesian approach

## Priors

Weakly informative priors inspired from McElreath (2020)
```{r prior}

prior <- c(
  set_prior("normal(0,1)", class = "b"), # can be improved
  set_prior("normal(0,1.5)",
    class = "b", # specific priors for parameters interpretable as the logit of an actual proportion
    # i.e. wasp-Origin-specific intercepts
    coef = c(
      "Wasp_host_speciesAphis_fabae_fabae",
      "Wasp_host_speciesAphis_hederae",
      "Wasp_host_speciesAphis_ruborum",
      "Wasp_host_speciesAphis_urticata"
    )
  ),
  set_prior("normal(0,1)", class = "sd"), # can be replaced by exponential(1) (larger)
  set_prior("lkj(2)", class = "cor") ## correlations between random effects
  # can loosen that with lkj(1)
)
```

## Model 1

Let's start with a simple binomial model:


```{r mod_binomial}
if (file.exists(here("R_output", "mod_binom.Rdata"))) {
  # this if-else statement is avoid re-fitting a model if there is already one existing in R_output
  # to override, re-run the model and re-save manually by selecting only the relevant code lines (or delete the Rdata object before relaunching this code chunk)
  load(here("R_output", "mod_binom.Rdata"))
} else {
  mod_binom <- brm(
    bf(Mummies_amount | trials(Nymphs_corrected) ~
      0 + Wasp_host_species + Wasp_host_species:Hamiltonella_host_species + ## origin in the wild are fixed effects
      (Aphid_line | Wasp_genotype) + ## but more generally, each wasp genotype has its own, random effect response to each Hamiltonella line
      (1 | replicate_fullID), ## random effect of the replicate inside each aphid line (not changing much)
    # (1|Block) #+ ## block effect is not valid since it's confounded with parasitoid line
    ## (see: data %>% select(Parasitoid_line,Block) %>% distinct() %>% table())
    family = "binomial"
    ),
    data = data,
    chains = 4, iter = 2000, seed = 666,
    prior = prior,
    backend = "cmdstanr"
  )

  save(list = c("mod_binom"), file = here("R_output", "mod_binom.Rdata"))
}
```

Let's check the fitting of the model and prediction vs observed distribution:

```{r pp_check}
pp_check(mod_binom)
pp_check(mod_binom, "stat_2d")
```

Not good fit of predictions, clear overdispersion.
We also have too low prediction of 0, but this is more likely the result of the overdispersion than actual zero-inflation.
At least, let's try to remedy the overdispersion before worrying about zero-inflation.
To do that, let's use a beta-binomial model


## Model 2: beta-binomial

```{r mod_betabinomial}
if (file.exists(here("R_output", "mod_betabinom.Rdata"))) {
  # this if-else statement is avoid re-fitting a model if there is already one existing in R_output
  # to override, re-run the model and re-save manually by selecting only the relevant code lines (or delete the Rdata object before relaunching this code chunk)
  load(here("R_output", "mod_betabinom.Rdata"))
} else {
  mod_betabinom <- brm(
    bf(Mummies_amount | trials(Nymphs_corrected) ~
      0 + Wasp_host_species + Wasp_host_species:Hamiltonella_host_species +
      (Aphid_line | Wasp_genotype) +
      (1 | replicate_fullID),
    nlf(phi ~ 1 / invphi),
    # easier to set priors on 1/phi than phi
    # see https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations#story-when-the-generic-prior-fails-the-case-of-the-negative-binomial
    invphi ~ 1,
    family = beta_binomial(link_phi = "identity")
    ),
    data = data,
    chains = 4, iter = 2000, seed = 666,
    prior = c(
      prior,
      set_prior("normal(0,1)", nlpar = "invphi", lb = 0) # half-normal prior on 1/phi
    ),
    backend = "cmdstanr"
  )

  save(list = c("mod_betabinom"), file = here("R_output", "mod_betabinom.Rdata"))
}
```


```{r pp_check_bis}
pp_check(mod_betabinom)
pp_check(mod_betabinom, "stat_2d")
```

Ok, that's better

# Plots and postprocessing

## Plots

Let's plot data and make comparisons based on the beta-binomial model

We generate predictions based on fixed effects only:

```{r fits_fix}
fits <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para, Origin_para2, Origin_ham2
  ) %>%
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_epred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup()
```



Plot

```{r plot_v1}
colors_aphid_lines=c(
  `NTR-407`="black",
  `TR-0016`=  "#ffc266",
  `TR-0042`= "#4dc3ff",
  `TR-0076`= "#00a0f0",
  `TR-0103`=  "#e68a00",
  `TR-0131`= "#995c00",
  `TR-0214`= "#9966ff",
  `TR-0244`= "#5c0aff",
  `TR-0619`= "#53c71a"
)

data <- data %>%
  arrange(Aphid_line) %>%
  arrange(Origin_ham) %>%
  arrange(Origin_para)

fits <- fits %>%
  arrange(Origin_ham2)

plot_v1 <- ggplot(fits) +
  geom_boxplot(
    data = data,
    aes(Origin_para,
      Mummies_amount / Nymphs_corrected,
      group = paste(Aphid_line, Parasitoid_line),
      color = Origin_para
    ),
    alpha = 0.3
  ) +
  stat_eye(aes(Origin_para, .epred),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  scale_x_discrete("*L. fabarum* original host") +
  scale_y_continuous("Proportion of nymphs parasitized") +
  scale_color_manual(values = colors_wasp2) +
  facet_wrap(~fct_relevel(Origin_ham2,rev), nrow = 5) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown()
  )


if (file.exists(here("R_output", "Parasitism_all_lines_mod_betabinom.pdf"))) {
  plot_v1 
} else {
  pdf(height = 8, width = 5, file = here("R_output", "Parasitism_all_lines_mod_betabinom.pdf"))
  plot_v1
  dev.off()
}
```

```{r plot_v2}
plot_v2 <- ggplot(fits) +
  geom_jitter(
    data = obsmeans,
    aes(Origin_para,
      mean_success_obs,
      color = Origin_para
    ),
    height = 0, width = 0.2,
    size = 2, alpha = 0.7
  ) +
  stat_eye(aes(Origin_para, .epred),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  scale_x_discrete("*L. fabarum* original host") +
  scale_y_continuous("Proportion of nymphs parasitized") +
  scale_color_manual(values = colors_wasp2) +
  facet_wrap(~fct_relevel(Origin_ham2,rev), nrow = 5) +
  theme_bw(base_size = 12) +
  theme(panel.grid.minor = element_blank()) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown()
  )


if (
  file.exists(
    here("R_output", "Parasitism_by_ham_origin_mod_betabinom.pdf")
  )
) {
  plot_v2 
} else {
  pdf(
    height = 5, width = 4,
    file = here("R_output", "Parasitism_by_ham_origin_mod_betabinom.pdf")
  )
  plot_v2
  dev.off()
}
```

Re-do fits, but scaled to the parasitism success of each wasp line against the defense-free aphids

```{r fits_fix2}
translate <- data %>%
  select(
    Origin_ham, Origin_para, Origin_para2, Hamiltonella_host_species,
    Wasp_host_species, Origin_ham2
  ) %>%
  distinct()

fits_scaled <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2, Origin_ham2
  ) %>%
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup() %>%
  group_by(Wasp_host_species) %>%
  compare_levels(.linpred,
    by = Hamiltonella_host_species, comparison = "control"
  ) %>%
  mutate(Hamiltonella_host_species = str_remove(Hamiltonella_host_species, " - none")) %>%
  left_join(translate) %>% 
  arrange(Origin_para) %>%
  arrange(Origin_ham2)
```

Scaled plot

```{r plot_scaled_by_hamiltonella_origin}

plot_scaled <- ggplot(fits_scaled) +
  stat_eye(aes(Origin_ham, .linpred, fill = Origin_ham),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  geom_hline(yintercept = 0, lty = 2) +
  scale_x_discrete("*H. defensa* origin") +
  scale_y_continuous("Relative parasitism success (vs no *H. defensa*, logit scale)") +
  scale_fill_manual(values = colors_wasp2) +
  facet_wrap(~fct_relevel(Origin_para2,rev), nrow = 4) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown()
  )

if (
  file.exists(
    here("R_output", "Relative_parasitism_all_lines_mod_betabinom.pdf")
  )
) {
  plot_scaled
} else {
  pdf(
    height = 4, width = 4,
    file = here("R_output", "Relative_parasitism_all_lines_mod_betabinom.pdf")
  )
  plot_scaled
  dev.off()
}
```

```{r plot_scaled_by_parasitoid_origin}
plot_scaled2 <- ggplot(subset(fits_scaled, fits_scaled$Hamiltonella_host_species != "none")) +
  stat_eye(aes(Origin_para, .linpred, fill = Origin_para),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  geom_hline(yintercept = 0, lty = 2) +
  scale_x_discrete("*L. fabarum* original host") +
  scale_y_continuous("Relative parasitism success (vs no *H. defensa*, logit scale)") +
  scale_fill_manual(values = colors_wasp2) +
  facet_wrap(~fct_relevel(Origin_ham2,rev), nrow = 4) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown()
  )

if (
  file.exists(
    here("R_output", "Relative_parasitism_all_lines_by_ham_mod_betabinom.pdf")
  )
) {
  plot_scaled2
} else {
  pdf(
    height = 6, width = 4,
    file = here("R_output", "Relative_parasitism_all_lines_by_ham_mod_betabinom.pdf")
  )
  plot_scaled2
  dev.off()
}
```

Similar to the above, a way to explore whether there is local adaptation is to compare, for each parasitoid origin, the predicted performance on aphids with "non-local" *Hamiltonella* (or no *Hamiltonella*) to the predicted performance on aphids with "local" *Hamiltonella*:

```{r}
fits_logit <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para, Origin_para2, Origin_ham2
  ) %>%
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup()

fits_logit %>%
  mutate(Ham_type = case_when(
    Hamiltonella_host_species == "none" ~ "no *H. defensa*",
    as.character(Hamiltonella_host_species) == as.character(Wasp_host_species) ~ "local",
    TRUE ~ "non-local *H. defensa*"
  )) %>%
  group_by(.draw, Wasp_host_species, Origin_para, Origin_para2, Ham_type) %>%
  summarise(.linpred = mean(.linpred)) %>%
  ungroup() %>%
  group_by(Wasp_host_species, Origin_para, Origin_para2) %>%
  compare_levels(.linpred, by = Ham_type, comparison = "control") %>%
  mutate(Ham_type = str_remove(Ham_type, " - local")) %>%
  ggplot() +
  stat_eye(aes(Ham_type, .linpred,fill=Origin_para),
    normalize = "xy",
    .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  scale_fill_manual(values = colors_wasp2) +
  scale_x_discrete("*Hamiltonella defensa* ?") +
  scale_y_continuous("Relative parasitism success (compared to same-origin *H. defensa*, logit scale)") +
  geom_hline(yintercept = 0, lty = 2) +
  facet_wrap(~fct_relevel(Origin_para2,rev), nrow = 4) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown()
  )
```

we can do the same, but without averaging the non-local:

```{r}

fits_logit2 <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2, Origin_ham2
  ) %>%
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup() %>%
  group_by(Wasp_host_species) %>%
  nest() %>% 
  mutate(local_level=map2(.x=Wasp_host_species,.y=data,
                  .f=~.y %>% compare_levels(.linpred, 
                                            by = Hamiltonella_host_species,
                                            comparison=emmeans_comparison("trt.vs.ctrl",ref=as.character(.x))(unique(.y$Hamiltonella_host_species))
                                             ))) %>% 
  select(Wasp_host_species,local_level) %>% 
  unnest(local_level) %>% 
  ungroup() %>% 
  mutate(Hamiltonella_host_species = str_split_fixed(Hamiltonella_host_species,pattern= " - ", n=2)[,1])
  

origin_info = data %>% select(Wasp_host_species,Hamiltonella_host_species,Origin_ham,Origin_para,Origin_para2) %>% distinct()

fits_logit2 %>% 
  left_join(origin_info) %>% 
  ggplot() +
  stat_eye(aes(Origin_ham, .linpred, fill=Origin_para),
           normalize = "xy",
           .width = c(0.001, 0.95), slab_alpha = 0.5
  ) +
  geom_hline(yintercept = 0, lty = 2) +
  scale_x_discrete("*H. defensa* origin") +
  scale_y_continuous("Relative parasitism success (vs \"local\" *H. defensa*, logit scale)") +
  scale_fill_manual(values = colors_wasp2) +
  facet_wrap(~fct_relevel(Origin_para2,rev), nrow = 4) +
  theme_bw(base_size = 12) +
  theme(
    legend.position = "none",
    strip.text = element_markdown(),
    axis.text.x = element_markdown(),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown()
  )
```



## Pairwise comparisons


Extract the modeled pairwise differences between treatments/variables

```{r pairwise_diff}
## Differences between parasitoid origins (host), by hamiltonella origin (original host)
fits %>%
  mutate(.iteration = .draw) %>%
  group_by(Hamiltonella_host_species) %>%
  compare_levels(.epred, by = Wasp_host_species) %>%
  mean_hdi(.epred) %>% ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.epred = round(.epred, digits = 2)) %>%
  mutate(.epred = cell_spec(.epred,
    color = ifelse(.epred > 0 & .lower > 0, "green",
      ifelse(.epred < 0 & .upper < 0,
        "red", "black"
      )
    )
  )) %>% ## color postive and negative values that do not overlap the zero
  kbl(booktabs = T, linesep = "", escape = FALSE) %>%
  kable_paper("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "300px")



## Differences between hamiltonella origins, par parasitoid origin
fits %>%
  mutate(.iteration = .draw) %>%
  group_by(Wasp_host_species) %>%
  compare_levels(.epred, by = Hamiltonella_host_species) %>%
  mean_hdi(.epred) %>% ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.epred = round(.epred, digits = 2)) %>%
  mutate(.epred = cell_spec(.epred,
    color = ifelse(.epred > 0 & .lower > 0, "green",
      ifelse(.epred < 0 & .upper < 0,
        "red", "black"
      )
    )
  )) %>%
  kbl(booktabs = T, linesep = "", escape = FALSE) %>%
  kable_paper("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "300px")



## All pairwise differences between all combinations of hamiltonella origin x parasitoid origin
fits %>%
  mutate(.iteration = .draw) %>%
  mutate(combo_wasp.ham = interaction(
    Wasp_host_species,
    Hamiltonella_host_species
  )) %>%
  compare_levels(.epred, by = combo_wasp.ham) %>%
  mean_hdi(.epred) %>% ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
  mutate(.epred = round(.epred, digits = 2)) %>%
  mutate(.epred = cell_spec(.epred,
    color = ifelse(.epred > 0 & .lower > 0, "green",
      ifelse(.epred < 0 & .upper < 0,
        "red", "black"
      )
    )
  )) %>%
  kbl(booktabs = T, linesep = "", escape = FALSE) %>%
  kable_paper("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "300px")
```

## Predicted vs observed comparison

To determine whether the beta-binomial model predicts well the expected line level parasitism success, we can re-do the prediction including aphid and parasitoid random effects:

```{r fits_RE}

fitsRE <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2,
    Aphid_line, Wasp_genotype
  ) %>% ## we include "lineage" variables for aphids (hamiltonella) and parasitoids
  distinct() %>%
  mutate(Nymphs_corrected = 1) %>%
  add_epred_draws(mod_betabinom,
    re_formula = ~ (Aphid_line | Wasp_genotype)
  ) %>% # we do not include random effects at a level below lineages
  ungroup()
```

And then do an observed vs predicted plot:

```{r}
left_join(obsmeans, fitsRE) %>%
  ggplot() +
  stat_pointinterval(aes(mean_success_obs, .epred),
    .width = c(0.001, 0.95)
  ) +
  scale_x_continuous("observed mean proportion of nymphs parasitized",
    breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)
  ) +
  scale_y_continuous("predicted mean proportion of nymphs parasitized",
    breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)
  ) +
  geom_abline(intercept = 0, slope = 1, lty = 2) +
  theme(aspect.ratio = 1)
```


```{r}
#
#############################################################################################################
########################### I don't remember what I wanted to do with this one ##############################
#############################################################################################################
#
# fitsRE %>%
#  mutate(.iteration = .draw) %>%
#  group_by(Aphid_line) %>%
#  compare_levels(.epred, by = Wasp_genotype) %>%
#  mean_hdi(.epred) %>% ## here with mean, but it also works with mean_hdi, median_qi, mean_qi
#  mutate(.epred = round(.epred, digits = 2)) %>%
#  mutate(.epred = cell_spec(.epred, color = ifelse(.epred > 0 & .lower > 0, "green", ifelse(.epred < 0 & .upper < 0, "red", #"black")))) %>%
#  kbl(booktabs = T, linesep = "", escape = FALSE) %>%
#  kable_paper("striped", full_width = F) %>%
#  scroll_box(width = "100%", height = "300px")
```

# variance partitioning: a quick and very dirty look (TO CHECK TO CONFIRM)

OK so this is a quick look on how much genotype pair-level variance is due to genotype origin vs. anything else about the genotype. It's on the *logit scale* (for how to do on the observed % scale, see: doi:10.1534/genetics.115.186536)(for how to partition the totality of the variance in the model, including within-genotype variance, see e.g. doi:10.1111/j.2041-210x.2012.00261.x and follow up publications by the same)

we first need to estimate the variance explained by fixed effects. Simple: we make predictions based on fixed effects only, then estimate their variance. Important: we make these predictions using every point of the original data (no "use distinct() to keep only one unique value" stuff)

```{r fits_fix_logit}
fits_logit_full <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2
  ) %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom, re_formula = NA) %>%
  ungroup()


var_fix <- fits_logit_full %>%
  group_by(.draw) %>%
  summarise(VF = var(.linpred))
```

Now we do the same with the variance explained by line-level random effects. If there were only random intercepts, it would be as simple as extracting the relevant variance parameter (the SDs you see in the summary). But we have random slopes (the wasp genotype-specific effects of each Hamiltonella). So the easier way (we can check later if is strictly right), is to simply do the same as above, but including these random effects in the predictions:

```{r fits_linelevel_logit}
fits_logit2_full <- data %>%
  select(
    Hamiltonella_host_species, Wasp_host_species,
    Origin_ham, Origin_para2,
    Aphid_line, Wasp_genotype
  ) %>%
  mutate(Nymphs_corrected = 1) %>%
  add_linpred_draws(mod_betabinom,
    re_formula = ~ (Aphid_line | Wasp_genotype)
  ) %>%
  ungroup()


var_partition <- fits_logit2_full %>%
  group_by(.draw) %>%
  summarise(Vline = var(.linpred)) %>%
  left_join(var_fix)
```

that's it! we can plot it

```{r plot_varpart}

ggplot(var_partition) +
  stat_halfeye(aes(VF / Vline), .width = c(0.001, 0.95)) +
  labs(
    x = "proportion of line-level variation explained by line origin hosts (logit scale)",
    y = ""
  )
```
